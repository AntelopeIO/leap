name: "Performance Harness Run"

on:
  workflow_dispatch:
    inputs:
      platform-choice:
        description: 'Override build platform'
        type: choice
        options:
        - ubuntu20
        - ubuntu22
      override-test-params:
        description: 'Override perf harness params'
        type: string
      override-leap-ref:
        description: 'Override leap ref'
        type: string

permissions:
  packages: read
  contents: read

defaults:
  run:
    shell: bash

jobs:

  v:
    name: Discover Inputs
    runs-on: ubuntu-latest
    outputs:
      test-params: ${{steps.overrides.outputs.test-params}}
      leap-ref: ${{steps.overrides.outputs.leap-ref}}
    steps:
      - name: Setup Input Params
        id: overrides
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          echo test-params=testBpOpMode >> $GITHUB_OUTPUT
          echo leap-ref='${{github.sha}}' >> $GITHUB_OUTPUT

          if [[ "${{inputs.override-test-params}}" != "" ]]; then
            echo test-params=${{inputs.override-test-params}} >> $GITHUB_OUTPUT
          fi
          if [[ "${{inputs.override-leap-ref}}" != "" ]]; then
            echo leap-ref=${{inputs.override-leap-ref}} >> $GITHUB_OUTPUT
          fi

  reuse-build:
    name: Reuse leap build
    needs: [v]
    if: |
      always() &&
      needs.v.result == 'success'
    runs-on: ubuntu-latest
    steps:
        - name: Download builddir
          uses: AntelopeIO/asset-artifact-download-action@v2
          with:
            owner: AntelopeIO
            repo: leap
            file: ${{github.event.inputs.platform-choice}}-build
            target: '${{needs.v.outputs.leap-ref}}'
            artifact-name: ${{github.event.inputs.platform-choice}}-build
            token: ${{github.token}}
            
        - name: Upload builddir
          uses: AntelopeIO/upload-artifact-large-chunks-action@v1
          with:
            name: ${{github.event.inputs.platform-choice}}-build
            path: build.tar.zst

  build-base:
    name: Run Build Workflow
    needs: [reuse-build]
    if: always() && needs.reuse-build.result != 'success'
    uses: ./.github/workflows/build_base.yaml
    with:
      override-build-matrix: ${{github.event.inputs.platform-choice}}
      leap-ref: ${{needs.v.outputs.leap-ref}}
    permissions:
      packages: write
      contents: read

  tests:
    name: Tests
    needs: [v, reuse-build, build-base]
    if: always() && (needs.build-base.result == 'success' || needs.reuse-build.result == 'success')
    runs-on: ubuntu-latest
    container:
      image: ${{fromJSON(needs.build-base.outputs.p)[github.event.inputs.platform-choice].image}}
    steps:
      - name: Download builddir
        uses: actions/download-artifact@v3
        with:
          name: ${{github.event.inputs.platform-choice}}-build
      - name: Run Performance Test
        run: |
          zstdcat build.tar.zst | tar x
          cd build
          ./tests/performance_tests/performance_test.py ${{needs.v.outputs.test-params}}
      - name: Prepare results
        id: prep-results
        run: |
          tar -pc build/performance_test | zstd --long -T0 -9 > performance_test_logs.tar.zst
      - name: Upload results
        uses: AntelopeIO/upload-artifact-large-chunks-action@v1
        with:
          name: performance-test-results
          path: performance_test_logs.tar.zst
      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-report
          path: ./build/performance_test/**/report.json
